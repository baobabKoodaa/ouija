<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <meta name="theme-color" content="#d35400" />
    <title>Ouija Online - A horror experience</title>
    <style>
        * {
            box-sizing: border-box;
        }

        p,
        h1,
        pre {
            margin: 0;
            padding: 0;
        }

        a {
            color: black;
            cursor: none;
        }

        html {
            height: 100%;
        }

        body {
            /* Using 32px margin around body to avoid funny business with cursor near the edges of window */
            margin: 32px;
            height: calc(100% - 64px);
            overflow-y: hidden;
            overflow-x: hidden;
            padding: 0;
            background: black;
        }

        @font-face {
            font-family: 'Feral';
            src: url('assets/Feral-Regular.woff2') format('woff2'),
                url('assets/Feral-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Carnivalee Freakshow';
            src: url('assets/CarnivaleeFreakshow.woff2') format('woff2'),
                url('assets/CarnivaleeFreakshow.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Kingthings Trypewriter 2';
            src: url('assets/KingthingsTrypewriter2.woff2') format('woff2'),
                url('assets/KingthingsTrypewriter2.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        h1 {
            font-size: 4vw;
        }

        #mobileWarning {
            display: none;
            background-color: white;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1100;
        }

        #settingsGearHoverboard {
            position: absolute;
            top: 0vw;
            right: 0vw;
            width: 6vw;
            height: 6vw;
            z-index: 998;
        }

        #settingsGear {
            position: absolute;
            top: 2vw;
            right: 2vw;
            width: 2vw;
            height: 2vw;
            fill: #d35400;
            opacity: 0.7;
            cursor: pointer;
            z-index: 999;
        }

        #settingsGear:hover {
            opacity: 1.0;
        }

        .popupContainer {
            display: none;
            z-index: 994;
            border: 1px solid black;
            border-radius: 10px;
            background-color: #fbedc8;
            color: black;
            font-size: 2vw;
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            padding: 1.5vw;
            cursor: none;
            transition: opacity 3s ease-in;
            opacity: 1.0;
            font-family: 'Carnivalee Freakshow';
            background-color: #fbedc8;
            background-image: url("data:image/svg+xml,%3Csvg width='180' height='180' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M82.42 180h-1.415L0 98.995v-2.827L6.167 90 0 83.833V81.004L81.005 0h2.827L90 6.167 96.167 0H98.996L180 81.005v2.827L173.833 90 180 96.167V98.996L98.995 180h-2.827L90 173.833 83.833 180H82.42zm0-1.414L1.413 97.58 8.994 90l-7.58-7.58L82.42 1.413 90 8.994l7.58-7.58 81.006 81.005-7.58 7.58 7.58 7.58-81.005 81.006-7.58-7.58-7.58 7.58zM175.196 0h-25.832c1.033 2.924 2.616 5.59 4.625 7.868C152.145 9.682 151 12.208 151 15c0 5.523 4.477 10 10 10 1.657 0 3 1.343 3 3v4h16V0h-4.803c.51.883.803 1.907.803 3 0 3.314-2.686 6-6 6s-6-2.686-6-6c0-1.093.292-2.117.803-3h10.394-13.685C161.18.938 161 1.948 161 3v4c-4.418 0-8 3.582-8 8s3.582 8 8 8c2.76 0 5 2.24 5 5v2h4v-4h2v4h4v-4h2v4h2V0h-4.803zm-15.783 0c-.27.954-.414 1.96-.414 3v2.2c-1.25.254-2.414.74-3.447 1.412-1.716-1.93-3.098-4.164-4.054-6.612h7.914zM180 17h-3l2.143-10H180v10zm-30.635 163c-.884-2.502-1.365-5.195-1.365-8 0-13.255 10.748-24 23.99-24H180v32h-30.635zm12.147 0c.5-1.416 1.345-2.67 2.434-3.66l-1.345-1.48c-1.498 1.364-2.62 3.136-3.186 5.14H151.5c-.97-2.48-1.5-5.177-1.5-8 0-12.15 9.84-22 22-22h8v30h-18.488zm13.685 0c-1.037-1.793-2.976-3-5.197-3-2.22 0-4.16 1.207-5.197 3h10.394zM0 148h8.01C21.26 148 32 158.742 32 172c0 2.805-.48 5.498-1.366 8H0v-32zm0 2h8c12.15 0 22 9.847 22 22 0 2.822-.53 5.52-1.5 8h-7.914c-.567-2.004-1.688-3.776-3.187-5.14l-1.346 1.48c1.09.99 1.933 2.244 2.434 3.66H0v-30zm15.197 30c-1.037-1.793-2.976-3-5.197-3-2.22 0-4.16 1.207-5.197 3h10.394zM0 32h16v-4c0-1.657 1.343-3 3-3 5.523 0 10-4.477 10-10 0-2.794-1.145-5.32-2.992-7.134C28.018 5.586 29.6 2.924 30.634 0H0v32zm0-2h2v-4h2v4h4v-4h2v4h4v-2c0-2.76 2.24-5 5-5 4.418 0 8-3.582 8-8s-3.582-8-8-8V3c0-1.052-.18-2.062-.512-3H0v30zM28.5 0c-.954 2.448-2.335 4.683-4.05 6.613-1.035-.672-2.2-1.16-3.45-1.413V3c0-1.04-.144-2.046-.414-3H28.5zM0 17h3L.857 7H0v10zM15.197 0c.51.883.803 1.907.803 3 0 3.314-2.686 6-6 6S4 6.314 4 3c0-1.093.292-2.117.803-3h10.394zM109 115c-1.657 0-3 1.343-3 3v4H74v-4c0-1.657-1.343-3-3-3-5.523 0-10-4.477-10-10 0-2.793 1.145-5.318 2.99-7.132C60.262 93.638 58 88.084 58 82c0-13.255 10.748-24 23.99-24h16.02C111.26 58 122 68.742 122 82c0 6.082-2.263 11.636-5.992 15.866C117.855 99.68 119 102.206 119 105c0 5.523-4.477 10-10 10zm0-2c-2.76 0-5 2.24-5 5v2h-4v-4h-2v4h-4v-4h-2v4h-4v-4h-2v4h-4v-4h-2v4h-4v-2c0-2.76-2.24-5-5-5-4.418 0-8-3.582-8-8s3.582-8 8-8v-4c0-2.64 1.136-5.013 2.946-6.66L72.6 84.86C70.39 86.874 69 89.775 69 93v2.2c-1.25.254-2.414.74-3.447 1.412C62.098 92.727 60 87.61 60 82c0-12.15 9.84-22 22-22h16c12.15 0 22 9.847 22 22 0 5.61-2.097 10.728-5.55 14.613-1.035-.672-2.2-1.16-3.45-1.413V93c0-3.226-1.39-6.127-3.6-8.14l-1.346 1.48C107.864 87.987 109 90.36 109 93v4c4.418 0 8 3.582 8 8s-3.582 8-8 8zM90.857 97L93 107h-6l2.143-10h1.714zM80 99c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zm20 0c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6z' fill='%23d9c99f' fill-opacity='0.24' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .popupContainer>ul {
            margin-top: 1.5vw;
            margin-bottom: 0;
        }

        .popupContainer>p,
        #tooltipContent>p {
            margin-top: 1.5vw;
        }

        .popupHoverboard {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 995;
        }

        .popupButtonsContainer {
            display: flex;
            flex-direction: row;
            width: 100%;
            text-align: center;
            margin-top: 1.5vw;
            z-index: 997;
            transition: margin-top 0.4s ease-in-out;
        }

        .popupButton {
            border: 1px solid black;
            border-radius: 10px;
            padding: 0.5vw;
            width: 100%;
            flex-grow: 1;
            z-index: 996;
        }

        .primaryButton {
            background-color: #958219;
            color: white;
            transition: 0.3s linear;
        }

        .primaryButton:hover {
            background-color: #968a47;
            box-shadow: 0 0 15px #5c533b;
            text-shadow: 0 0 5px #5c533b;
        }

        #consentNo {
            background-color: #ebebeb;
            margin-left: 1.5vw;
            transition: 0.3s linear;
        }

        #consentNo:hover {
            color: gray;
        }

        #tooltipContinueButton {
            height: 4vw;
            line-height: 2.6vw;
        }

        #tooltipShutUpButton {
            height: 4vw;
            line-height: 2.6vw;
            background-color: #ebebeb;
            margin-left: 1.5vw;
            transition: 0.3s linear;
        }

        #tooltipShutUpButton:hover {
            color: gray;
        }

        #saveSettings {
            height: 4vw;
            line-height: 2.6vw;
        }

        #textInputAPIKey {
            background-color: white;
            position: absolute;
            border-radius: 5px;
            margin-top: 1.7vw;
            width: 31.3vw;
            left: 7vw;
            height: 2vw;
            line-height: 2vw;
            transition: margin-top 0.4s ease-in-out;
        }

        .externalLinkRow {
            position: relative;
            display: inline-block;
            width: 100%;
            text-align: center;
            margin-top: 1.5vw;
            z-index: 997;
            text-align: left;
        }

        .externalLinkRow svg {
            height: 2.6vw;
            vertical-align: middle;
            fill: #958219;
        }

        .externalLinkRow span {
            vertical-align: middle;
        }

        .externalLinkRow:hover {
            opacity: 0.5;
        }

        #popupSettings {
            z-index: 996;
        }

        .switch {
            position: relative;
            display: block;
            width: 4.6vw;
            height: 2.6vw;
            z-index: 996;
            margin-top: 1.5vw;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: none;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:not(.checked):hover {
            background-color: #bbb;
        }

        .slider.checked:hover {
            background-color: #968a47;
        }

        .slider-text {
            position: absolute;
            display: inline-block;
            left: 5.6vw;
            height: 2.4vw;
            width: 30vw;
            line-height: 2.4vw;
            pointer-events: none;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 2.0vw;
            width: 2.0vw;
            left: 0.3vw;
            bottom: 0.3vw;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        .checked {
            background-color: #958219;
        }

        .checked:before {
            -webkit-transform: translateX(2.0vw);
            -ms-transform: translateX(2.0vw);
            transform: translateX(2.0vw);
        }

        #bg {
            position: relative;
            width: 100%;
            height: 100%;
            cursor: none;
            z-index: 9;
        }

        @keyframes board-glow {
            0% {
                box-shadow: 0 0 50px #d35400;
            }

            100% {
                box-shadow: 0 0 50px 20px #d35400;
            }
        }

        @keyframes scale-up-down {
            0% {
                transform: scale(1.0)
            }

            50% {
                transform: scale(1.1)
            }

            100% {
                transform: scale(1.0)
            }
        }

        @keyframes rotate-circle {
            0% {
                transform: rotateZ(0deg)
            }

            100% {
                transform: rotateZ(180deg)
            }
        }

        .one-time-bump {
            animation-name: scale-up-down;
            animation-iteration-count: 1;
            animation-duration: 0.5s;
        }

        .one-time-gear-roll {
            animation-name: rotate-circle;
            animation-timing-function: cubic-bezier(.12, 1, .96, .97);
            animation-iteration-count: 1;
            animation-fill-mode: forwards;
            animation-duration: 1s;
        }

        #boardContainer {
            position: absolute;
            width: 50%;
            left: 50%;
            top: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        #board {
            position: relative;
            width: 100%;
            border-radius: 10%;
            z-index: 11;
            animation-name: board-glow;
            animation-iteration-count: infinite;
            animation-duration: 2s;
            animation-timing-function: ease-in-out;
            animation-direction: alternate;
        }

        #hoverBoard {
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            z-index: 12;
            cursor: none;
        }

        #planchette,
        #planchetteHelper {
            position: absolute;
            top: 44%;
            left: 40.5%;
            width: 18%;
            transform: rotate(130deg);
            cursor: none;
        }

        #planchette {
            z-index: 15;
            transition: filter 1.5s ease-in;
            /* TODO ease-in-out? */
        }

        .planchette-no-glow {
            filter: drop-shadow(5px 5px 5px #222);
        }

        .planchette-active-glow {
            filter: drop-shadow(5px 5px 5px rgb(255, 198, 198));
            /** filter: drop-shadow(5px 5px 5px '#fce'); */
        }

        #planchetteHelper {
            z-index: 16;
            opacity: 0;
            /* Can't use visibility:hidden because need mouse movements to trigger events */
        }

        #magnifying-glass {
            background-image: url('assets/ouija_bg.jpg');
            background-repeat: no-repeat;
            position: absolute;
            border-radius: 50%;
            cursor: none;
            visibility: hidden;
            z-index: 14;
        }

        #magnifying-glass-surface {
            background-color: #563e23;
            opacity: 0.4;
            width: 100%;
            height: 100%;
        }

        #tooltipContainer {
            position: absolute;
            right: 0;
            bottom: 2vw;
            width: 10vw;
            height: 15vw;
            z-index: 12;
            cursor: none;
            pointer-events: none;
            filter: url(#smokeFilter);
        }

        #tooltipSymbol {
            line-height: 15vw;
            font-family: 'Kingthings Trypewriter 2', 'Courier New', 'Courier', monospace;
            font-size: 14vw;
            color: black;
            text-align: center;
            vertical-align: middle;
            filter: blur(11px);
            transform: scale(0.0);
            transition: filter 2s ease-out, transform 2s ease-in-out, opacity 2s ease-in-out;
            /* color: transparent;
            background: linear-gradient(#fff, #999, #ddd, #888);
            background-clip: text;
            -webkit-background-clip: text; */
        }

        #spiritMessageContainer {
            position: absolute;
            top: -13%;
            pointer-events: none;

            /* Centering */
            left: -50%;
            width: 100vw;
            text-align: center;
            letter-spacing: 3vw;
            text-indent: 3vw;

            /* Styling */
            font-size: 2vw;
            color: #fff;
            text-shadow: 0 0 5px #d35400;
            text-transform: uppercase;
            font-family: 'Feral';

        }

        #spiritMessageContainer::before,
        #spiritMessageContainer::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        #spiritMessageContainer::before {
            color: #f3ba39;
            animation: glitch-effect 6s infinite;
        }

        #spiritMessageContainer::after {
            color: #f3ba39;
            animation: glitch-effect 4s infinite;
        }

        @keyframes glitch-effect {
            0% {
                left: -4px;
                top: -4px;
            }

            25% {
                left: 4px;
                top: 0px;
            }

            50% {
                left: -2px;
                top: 4px;
            }

            75% {
                left: 2px;
                top: -2px;
            }

            100% {
                left: 0px;
                top: -4px;
            }
        }

        #userMessageContainer {
            position: absolute;
            left: -50%;
            bottom: -13%;
            display: flex;
            justify-content: center;
            width: 100vw;
            height: 3vh;
            pointer-events: none;
        }

        #userMessagePre {
            position: absolute;
            height: 3vh;
            line-height: 3vh;
            font-size: 2vw;
            letter-spacing: 0.8vw;
            text-transform: uppercase;
            font-family: 'Kingthings Trypewriter 2', 'Courier New', 'Courier', monospace;
            color: #fff;
            transition: color 1.0s ease-out;
        }

        .blinking-caret {
            border-right: .15em solid #ff9900;
            animation: blink-caret .75s step-end infinite;
        }

        @keyframes blink-caret {

            from,
            to {
                border-color: transparent
            }

            50% {
                border-color: #ff9900;
            }
        }

        .orangey-text {
            color: #563e23 !important;
        }

        #cursor {
            position: absolute;
            top: 30%;
            left: 30%;
            height: 33px;
            /* height must be evenly divisible from 128px */
            visibility: hidden;
            pointer-events: none;
            z-index: 1000;
        }

        .unselectable {
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
            -ms-user-select: none;

            user-drag: none;
            -webkit-user-drag: none;
        }

        .disable-transitions {
            transition: none !important;
        }

        @media only screen and (max-width: 760px) {
            .mobile-warning {
                display: block;
            }
        }
    </style>

    <script>

        // String literals
        const ON_PLANCHETTE = 'onPlanchette'
        const ON_USER_MESSAGE = 'onUserMessage'
        const ON_BUTTON = 'onButton'
        const ON_TEXT_INPUT = 'onTextInput'
        const SHUT_UP = 'shutUp'
        const RECORDING = 'recording'
        const TURN_SPIRIT = 'turnSpirit'
        const TURN_USER = 'turnUser'
        const OUIJA_USER_ID = 'ouija-user-id'

        // Global state
        let popupIsOpen = false
        let showTips = true
        let draggingPlanchette = false
        let planchetteTransformX = 0 // In % relative to planchette's own size (to support browser resizing)
        let planchetteTransformY = 0 // In % relative to planchette's own size (to support browser resizing)
        let prevX = undefined
        let prevY = undefined
        let offsetX = 0 // In % relative to planchette's size (to support browser resizing consistently with planchetteHelper)
        let offsetY = 0 // In % relative to planchette's size (to support browser resizing consistently with planchetteHelper)
        let userMoveCount = 0
        let remainingGoals = ''
        let revealedSpiritLetters = ''
        let userMessage = ''
        let currentExchangeNumber = 0
        let turn = TURN_USER
        let hoveringOverTooltip = false
        let speedMode = false
        let revealMouse = false
        let debug = {}

        // Magnifier constants
        const MAG_ZOOM = 1.2
        const MAG_LEFT = 0.465
        const MAG_TOP = 0.58

        // Offset constants
        const SPIRIT_MAX_DIST = 60.0
        const SPIRIT_STOCHASTIC_STR = 0.6
        const SPIRIT_ACCEL_STR = 1.4
        const OFFSET_CANCELLATION_STR = 0.3
        const OFFSET_CANCELLATION_LOW_URGENCY = 0.3

        // Planchette drag limitations (board area)
        const HARD_Y_MAX = 80
        const HARD_Y_MIN = -160
        const HARD_X_MAX = 270
        const HARD_X_MIN = -255
        const SOFT_Y_MAX = HARD_Y_MAX - 10
        const SOFT_Y_MIN = HARD_Y_MIN - 10
        const SOFT_X_MAX = HARD_X_MAX - 10
        const SOFT_X_MIN = HARD_X_MIN - 10

        // User message constants
        USER_MESSAGE_MAX_LENGTH = 40

        // Goal constants. Coordinates are in % relative to planchette transform.
        const ALLOWED_CHARS = 'abcdefghijklmnopqrstuvwxyz1234567890'
        const CHAR_SELECT_MAX_DIST = 10
        const goalCoords = {
            "0": { "x": 96.57, "y": -0.67 },
            "1": { "x": -110.95, "y": -1.07 },
            "2": { "x": -92.67, "y": -0.27 },
            "3": { "x": -69.56, "y": -0.27 },
            "4": { "x": -45.9, "y": -0.27 },
            "5": { "x": -23.86, "y": -0.27 },
            "6": { "x": -1.28, "y": -0.67 },
            "7": { "x": 20.23, "y": -0.67 },
            "8": { "x": 42.27, "y": -0.27 },
            "9": { "x": 67.54, "y": -0.67 },
            "a": { "x": -159.6, "y": -58.17 },
            "b": { "x": -139.2, "y": -77.69 },
            "c": { "x": -115.5, "y": -91.63 },
            "d": { "x": -91.94, "y": -101.99 },
            "e": { "x": -64.52, "y": -110.36 },
            "f": { "x": -35.48, "y": -115.5 },
            "g": { "x": -6.57, "y": -116.62 },
            "h": { "x": 24.94, "y": -115.17 },
            "i": { "x": 52.9, "y": -111.67 },
            "j": { "x": 74.94, "y": -105.69 },
            "k": { "x": 105.05, "y": -94.14 },
            "l": { "x": 130.32, "y": -79.4 },
            "m": { "x": 152.9, "y": -63.06 },
            "n": { "x": -152.8, "y": -7.68 },
            "o": { "x": -136.2, "y": -22.82 },
            "p": { "x": -117.9, "y": -36.37 },
            "q": { "x": -94.81, "y": -47.92 },
            "r": { "x": -65.24, "y": -57.48 },
            "s": { "x": -36.75, "y": -63.46 },
            "t": { "x": -6.75, "y": -67.17 },
            "u": { "x": 24.53, "y": -65.21 },
            "v": { "x": 55.17, "y": -60.83 },
            "w": { "x": 86.36, "y": -51.67 },
            "x": { "x": 111.63, "y": -37.72 },
            "y": { "x": 134.21, "y": -24.18 },
            "z": { "x": 147.65, "y": -9.44 }
        }

        // Tooltip hovering area. Coordinates are relative to planchette's size.
        const tooltipHoverArea = {
            top: 0.57,
            left: 0.83,
            bottom: 0.87,
            right: 0.96
        }

        // Memoize some values to reduce reflows (improve performance).
        let boardWidth = 0
        let boardHeight = 0
        let boardTop = 0
        let boardLeft = 0
        let planchetteWidth = 0
        let planchetteHeight = 0
        let magSize = 0
        let windowWidth = 0
        let windowHeight = 0
        const resizeUpdates = function () {
            // Update memoized values
            const boardBounds = document.getElementById('boardContainer').getBoundingClientRect()
            boardTop = boardBounds.top
            boardLeft = boardBounds.left
            boardWidth = boardBounds.width
            boardHeight = boardBounds.height
            const planchette = document.getElementById('planchette')
            planchetteWidth = planchette.clientWidth
            planchetteHeight = planchette.clientHeight
            windowWidth = window.innerWidth
            windowHeight = window.innerHeight

            // Update magnifying glass
            const mag = document.getElementById('magnifying-glass')
            magSize = planchetteWidth * 0.40
            Object.assign(mag.style, {
                left: (100 * MAG_LEFT) + "%",
                top: (100 * MAG_TOP) + "%",
                width: magSize + 'px', // TODO %
                height: magSize + 'px', // TODO %
                backgroundSize: (MAG_ZOOM * 100 * boardWidth / magSize) + '% ' + (MAG_ZOOM * 100 * boardHeight / magSize) + '%',
                visibility: 'visible'
            })
            updateMagnifyingGlassPosition()

            // Fix edge case where user sees 2 cursors when using keyboard shortcut to resize browser
            if (cursor) {
                cursor.style.visibility = "hidden";
            }
        }
        // Call resizeUpdates after the first complete render and after each resize
        window.addEventListener('load', function (event) {
            resizeUpdates()
        });
        window.addEventListener('resize', function (event) {
            resizeUpdates()
        });

        const LOG_ENDPOINT = 'https://endpoint1.collection.eu.sumologic.com/receiver/v1/http/ZaVnC4dhaV0vBIvS0oahg-8LYhDkyFCtWZ2zZ_7NbP0x0PYd0DmEk2cLgA4DJlePqnHWB5KjcxPFudwdOmtop0b6isr9VgLeKHYmzJ6eSqkD0cyZ6FNQiQ=='
        const logToSumoLogic = function (message) {
            if (window.localStorage.getItem('ouija-dont-log-myself')) {
                // Exclude debug testing messages from logs (use incognito if you need to test logging)
                return
            }
            try {
                const augmentedMessage = `${window.localStorage.getItem(OUIJA_USER_ID)}:${Date.now()}:${using_GPT3 ? "GPT-3" : "Simple"}:${message}`
                fetch(`${LOG_ENDPOINT}?${augmentedMessage}`)
            } catch (ex) {
                console.log('Logging to Sumo Logic failed', ex)
            }
        }

        const paintCursorWithOffset = function (cursor, realX, realY) {
            let x = realX + offsetX * planchetteWidth / 100
            let y = realY + offsetY * planchetteHeight / 100
            cursor.style.top = (y - boardTop) + "px";
            cursor.style.left = (x - boardLeft) + "px";
        }

        const updateMagnifyingGlassPosition = function () {
            const mag = document.getElementById('magnifying-glass')
            const xMoveWithOffset = planchetteTransformX + offsetX
            const yMoveWithOffset = planchetteTransformY + offsetY

            // Move location of the magnifying glass
            const xMag = xMoveWithOffset * planchetteWidth / magSize
            const yMag = yMoveWithOffset * planchetteHeight / magSize
            mag.style.transform = `translateX(${xMag}%) translateY(${yMag}%)`;

            // Move background image inside magnifying glass (using pixels because I couldn't get % to work, this is why we have to call this method inside resizeUpdates)
            const xBgPosPx = -(xMoveWithOffset * planchetteWidth + MAG_LEFT * 100 * boardWidth) / 100 * MAG_ZOOM - magSize * MAG_ZOOM * (1 - 1 / MAG_ZOOM) / 2
            const yBgPosPx = -(yMoveWithOffset * planchetteHeight + MAG_TOP * 100 * boardHeight) / 100 * MAG_ZOOM - magSize * MAG_ZOOM * (1 - 1 / MAG_ZOOM) / 2
            mag.style.backgroundPosition = `${xBgPosPx}px ${yBgPosPx}px`
        }

        const updatePlanchettePosition = function () {
            const planchette = document.getElementById('planchette')
            const planchetteHelper = document.getElementById('planchetteHelper')

            planchette.style.transform = `translateX(${planchetteTransformX + offsetX}%) translateY(${planchetteTransformY + offsetY}%) rotate(130deg)`;
            planchetteHelper.style.transform = `translateX(${planchetteTransformX}%) translateY(${planchetteTransformY}%) rotate(130deg)`;
            updateMagnifyingGlassPosition()
        }

        const spiritGuidanceToOffset = function (x, y, diffX, diffY, goalX, goalY, dist) {
            const accelDistanceMultiplier = (SPIRIT_MAX_DIST - dist) / SPIRIT_MAX_DIST
            if (Math.random() > SPIRIT_STOCHASTIC_STR) {
                return
            }
            // TODO kokeile vaihtoehtosta kiihdytysta missa on vaan 1 paatos et kiihdytetaanko/hidastetaanko MAALIN SUUNTAISESTI (seka x etta y akseleilla) 
            if (diffX != 0 && Math.sign(goalX - x) == Math.sign(diffX)) { // X axis move is in preferable direction
                if (dist > 5) { // reduce jittery accels on top of goal
                    offsetX += diffX * SPIRIT_ACCEL_STR * 1.1 * 100.0 / planchetteWidth // accelerate
                }
            } else if (diffX != 0) { // X axis move is in undesired direction
                if (dist < 10) { // sharp cutoff for deceleration to reinforce feeling of "magnetic force" and to reduce unnecessary offsetting
                    offsetX -= diffX * SPIRIT_ACCEL_STR * accelDistanceMultiplier * 100.0 / planchetteWidth // decelerate
                }
            }
            if (diffY != 0 && Math.sign(goalY - y) == Math.sign(diffY)) { // Y axis move is in preferable direction
                if (dist > 5) {
                    offsetY += diffY * SPIRIT_ACCEL_STR * 1.1 * 100.0 / planchetteHeight // accelerate
                }
            } else if (diffY != 0) {
                if (dist < 10) {
                    offsetY -= diffY * SPIRIT_ACCEL_STR * accelDistanceMultiplier * 100.0 / planchetteHeight // decelerate
                }
            }
        }

        const clearOffsets = function () {
            if (offsetX != 0) {
                planchetteTransformX += offsetX // This negates any effect on planchette positioning
                offsetX = 0
            }
            if (offsetY != 0) {
                planchetteTransformY += offsetY
                offsetY = 0
            }
        }

        const cancelSomeOffset = function (diffX, diffY, urgency) {
            // Will accelerate or decelerate latest mouse move in an effort to reduce offset
            const e = OFFSET_CANCELLATION_STR * urgency
            if (Math.abs(offsetX) > 1) {
                const sign = (Math.sign(offsetX) == Math.sign(diffX) ? -1 : 1) // Decelerate or accelerate depending on sign
                offsetX += sign * diffX * e
                if (!draggingPlanchette) {
                    // When planchette is not being dragged, we need to do this to "negate" the effect on planchette position
                    planchetteTransformX -= sign * diffX * e
                }
            }
            if (Math.abs(offsetY) > 1) {
                const sign = (Math.sign(offsetY) == Math.sign(diffY) ? -1 : 1)
                offsetY += sign * diffY * e
                if (!draggingPlanchette) {
                    planchetteTransformY -= sign * diffY * e
                }
            }
        }

        const startedHoverOnTooltip = function () {
            document.getElementById('tooltipSymbol').style.filter = 'blur(2px)'
            // Set 'from' attribute to make animation smooth even when the user abruptly moves in and out with the mouse
            document.getElementById('animateToFocus').setAttributeNS(null, 'from', document.getElementById('smokeFilterMap').scale.animVal)
            document.getElementById('animateToFocus').beginElement()
        }

        const stoppedHoverOnTooltip = function () {
            document.getElementById('tooltipSymbol').style.filter = 'blur(11px)'
            document.getElementById('animateRemoveFocus').setAttributeNS(null, 'from', document.getElementById('smokeFilterMap').scale.animVal)
            document.getElementById('animateRemoveFocus').beginElement()
        }

        const mouseMoved = function (event, onObject) {
            const currX = event.clientX
            const currY = event.clientY
            const diffX = (userMoveCount > 0 ? currX - prevX : 0)
            const diffY = (userMoveCount > 0 ? currY - prevY : 0)
            prevX = currX
            prevY = currY
            userMoveCount += 1

            if (draggingPlanchette) {
                const x = planchetteTransformX + offsetX + diffX * 100.0 / planchetteWidth
                const y = planchetteTransformY + offsetY + diffY * 100.0 / planchetteHeight
                if (y > HARD_Y_MAX || y < HARD_Y_MIN || x > HARD_X_MAX || x < HARD_X_MIN) {
                    // Prevent planchette from being moved outside board
                    stopDraggingPlanchette(event)
                    return
                }
                planchetteTransformX += diffX * 100.0 / planchetteWidth
                planchetteTransformY += diffY * 100.0 / planchetteHeight

                const goalX = remainingGoals.length > 0 ? goalCoords[remainingGoals[0]].x : -10000
                const goalY = remainingGoals.length > 0 ? goalCoords[remainingGoals[0]].y : -10000

                // Possibly accelerate/decelerate move by modifying cursor offset
                const dist = Math.sqrt((x - goalX) * (x - goalX) + (y - goalY) * (y - goalY))
                if (dist < SPIRIT_MAX_DIST) {
                    // Modify cursor offset to guide the user towards goal
                    // TODO Even if we are dragging we sometimes have to reduce offset to prevent the real cursor from escaping window.
                    spiritGuidanceToOffset(x, y, diffX, diffY, goalX, goalY, dist)
                } else {
                    // User dragging planchette but is not near goal, use this opportunity to
                    // reduce cursor offset to prevent the real cursor from escaping window.
                    if (y < SOFT_Y_MAX && y > SOFT_Y_MIN && x < SOFT_X_MAX && x > SOFT_X_MIN) {
                        // Soft limits are used to prevent us from accelerating the user beyond hard limits where planchette would be trapped
                        cancelSomeOffset(diffX, diffY, OFFSET_CANCELLATION_LOW_URGENCY)
                    }
                }
            } else {
                // User is not dragging planchette.

                // Take the opportunity to reduce cursor offset to prevent the real cursor from escaping window.
                // We need coordinates relative to viewport.
                let x = (currX + offsetX * planchetteWidth / 100) / windowWidth
                let y = (currY + offsetY * planchetteHeight / 100) / windowHeight
                const minimumEscapeDistance = Math.min(Math.abs(x - 0), Math.abs(x - 1), Math.abs(y - 1), Math.abs(y - 0))
                if (minimumEscapeDistance > 0.04) {
                    // TODO instead of linear we need to have exponential urgency towards the edges of window
                    const urgency = Math.max(1 - minimumEscapeDistance / 0.30, OFFSET_CANCELLATION_LOW_URGENCY)
                    cancelSomeOffset(diffX, diffY, urgency)
                } else {
                    // We are too close to the edge, immediately cancel all offset
                    clearOffsets()
                }

                // Determine if user's fake cursor is hovering over tooltip.
                // We need coordinates relative to board (to support browser resizing).
                x = (x * windowWidth - boardLeft) / boardWidth
                y = (y * windowHeight - boardTop) / boardHeight
                if (showTips && !popupIsOpen && !pauseSmokeAnimation && x > tooltipHoverArea.left && x < tooltipHoverArea.right && y > tooltipHoverArea.top && y < tooltipHoverArea.bottom) {
                    // We are hovering over tooltip.
                    if (!hoveringOverTooltip) {
                        // We just now entered the hover area.
                        hoveringOverTooltip = true
                        startedHoverOnTooltip()
                    }
                } else {
                    // We are not hovering over tooltip (or popup is open so we dont do the hover effect anyway).
                    if (hoveringOverTooltip) {
                        // We just now left the hover area.
                        hoveringOverTooltip = false
                        stoppedHoverOnTooltip()
                    }
                }

            }
            updatePlanchettePosition()

            const chooseCursorIcon = function () {
                if (draggingPlanchette) return 'assets/grabbing.cur'
                if (onObject === ON_PLANCHETTE && turn === TURN_SPIRIT) return 'assets/grab.cur'
                if (onObject === ON_BUTTON) return 'assets/aero_link.cur'
                if (hoveringOverTooltip) return 'assets/aero_link.cur'
                return 'assets/aero_arrow.cur'
            }

            const cursor = document.getElementById("cursor")
            const newCursorSrc = chooseCursorIcon()
            if (cursor.src !== newCursorSrc) cursor.src = newCursorSrc
            cursor.style.visibility = "visible";
            paintCursorWithOffset(cursor, prevX, prevY)
        }

        const startDraggingPlanchette = function (event) {
            if (turn === TURN_SPIRIT) {
                draggingPlanchette = true
                cursor.src = "assets/grabbing.cur"
            }
        }
        const stopDraggingPlanchette = function (event, source) {
            draggingPlanchette = false
            const newCursor = (source === ON_PLANCHETTE ? 'assets/grab.cur' : 'assets/aero_arrow.cur')
            cursor.src = newCursor
            const x = planchetteTransformX + offsetX
            const y = planchetteTransformY + offsetY
            if (source === ON_PLANCHETTE) {
                if (debug[RECORDING]) {
                    const chars = ALLOWED_CHARS
                    let i = 0
                    while (debug[RECORDING][chars[i]]) i++
                    debug[RECORDING][chars[i]] = {
                        x: Math.round(100 * x) / 100,
                        y: Math.round(100 * y) / 100,
                    }
                    console.log(debug[RECORDING])
                } else {
                    // What is the closest character to planchette
                    let closestDist = 99999999
                    let closestChar = 'a'
                    for (let i = 0; i < ALLOWED_CHARS.length; i++) {
                        const char = ALLOWED_CHARS[i]
                        const c = goalCoords[char]
                        const dist = Math.sqrt((x - c.x) * (x - c.x) + (y - c.y) * (y - c.y))
                        if (dist < closestDist) {
                            closestDist = dist
                            closestChar = char
                        }
                    }
                    if (closestDist < CHAR_SELECT_MAX_DIST) {
                        // Close enough, interpret that user intends to select this character
                        if (remainingGoals.length > 0 && closestChar === remainingGoals[0]) {
                            // Selected character was goal, move onto the next goal.
                            addCharToRevealedMessage(closestChar)
                            remainingGoals = remainingGoals.substring(1)
                            if (remainingGoals.length === 0) {
                                console.log('Spirit: ' + revealedSpiritLetters.toUpperCase())
                                document.getElementById('planchette').classList = ['unselectable planchette-no-glow']
                                document.getElementById('userMessagePre').classList = ['unselectable blinking-caret']
                                document.getElementById('userMessagePre').innerText = ''
                                turn = TURN_USER
                                currentExchangeNumber++
                                if (currentExchangeNumber === 1 && showTips) {
                                    stopSmokeAnimation()
                                    setTimeout(() => createTooltip(2), 2500)
                                }
                            }
                        }
                    }
                }
            }
            event.stopPropagation()
        }

        const addCharToRevealedMessage = function (char) {
            revealedSpiritLetters += char
            const container = document.getElementById('spiritMessageContainer')
            container.innerText = revealedSpiritLetters
            container.setAttribute('data-text', revealedSpiritLetters)
        }

        const switchTurnToSpirit = function () {
            turn = TURN_SPIRIT

            // Clear previously revealed spirit message
            revealedSpiritLetters = ''

            // Indicate to user that planchette can be dragged
            document.getElementById('planchette').classList = ['unselectable planchette-active-glow']

            // Clear previously revealed answer from visuals
            const container = document.getElementById('spiritMessageContainer')
            container.innerText = ''
            container.setAttribute('data-text', '')

            // Stop blinking caret
            document.getElementById('userMessagePre').classList = ['unselectable orangey-text']

            // Maybe update tooltip
            if (showTips && currentExchangeNumber === 0) {
                stopSmokeAnimation()
                setTimeout(() => createTooltip(1), 2500)
            }
        }

        const spiritIsReadyToCommunicate = function (rawMessage) {
            const message = rawMessage.toLocaleLowerCase().replace(/[^0-9a-z]/gi, '')
            const container = document.getElementById('spiritMessageContainer')

            logToSumoLogic(previousInput + " -> " + message)

            if (speedMode) {
                turn = TURN_USER
                revealedSpiritLetters = message
                console.log('Spirit: ' + revealedSpiritLetters.toUpperCase())
                container.innerText = message
                container.setAttribute('data-text', message)
                document.getElementById('userMessagePre').innerText = ''
                document.getElementById('userMessagePre').classList = ['unselectable blinking-caret']
                document.getElementById('planchette').classList = ['unselectable planchette-no-glow']
                currentExchangeNumber++
                if (currentExchangeNumber === 1 && showTips) {
                    stopSmokeAnimation()
                    setTimeout(() => createTooltip(2), 5000)
                }
                return
            }
            remainingGoals = message // Set incoming message as new goals
        }

        const TOOLTIP_CONTENTS = [
            {
                tooltip: '?',
                headline: 'And so it begins',
                paragraphs: [
                    'You can use the ouija board to communicate with the spirit world. To send a message, type on your keyboard and press enter.'
                ]
            },
            {
                tooltip: '?',
                headline: 'A message from beyond',
                paragraphs: [
                    'The planchette is glowing! That means a spirit is trying to communicate.',
                    'The spirit needs your help to move the planchette. Drag the planchette with your mouse over the letters and numbers on the board. When you are close to the mark, you will feel it. The spirit will pull you in.',
                    'Drop the planchette on the correct letters to reveal the message.',
                    'If you are having trouble, try hovering slowly with different patterns.'
                ]
            },
            {
                tooltip: 'O',
                headline: 'Objective',
                paragraphs: [
                    `That's a good start, looks like you're getting the hang of it. We need to keep this thing talking in order trap it.`,
                    `If you can, find out who... and what... we're dealing with here.`,
                ]
            }
        ]

        const createTooltip = function (i) {
            const t = TOOLTIP_CONTENTS[i]
            document.getElementById('tooltipSymbol').innerText = t.tooltip
            document.getElementById('tooltipContent').innerHTML = `<h1>${t.headline}</h1>\n${t.paragraphs.map((str) => '<p>' + str + '</p>\n').join("")}`
            if (showTips) {
                startSmokeAnimation()
            }
        }

        const openTooltipPopup = function (e) {
            clearOffsets()
            mouseMoved(e) // To update cursor location after clearing offsets.
            document.getElementById('board').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('planchette').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('planchetteHelper').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('spiritMessageContainer').style.visibility = `hidden`
            document.getElementById('userMessageContainer').style.visibility = `hidden`
            document.getElementById('tooltipPopup').style.opacity = '1'
            document.getElementById('tooltipPopup').style.display = `block`
        }

        const closeTooltipPopup = function (shutUp) {
            if (shutUp) toggleShowTips()
            document.getElementById('settingsGear').classList.remove(['one-time-gear-roll'])
            document.getElementById('planchette').style.removeProperty('filter')
            document.getElementById('tooltipPopup').style.display = 'none'
            document.getElementById('board').style.filter = `none`;
            document.getElementById('planchetteHelper').style.filter = `none`;
            document.getElementById('spiritMessageContainer').style.visibility = `visible`
            document.getElementById('userMessageContainer').style.visibility = `visible`;
        }

        const toggleTooltipPopup = function (e, shutUp) {
            popupIsOpen = !popupIsOpen
            popupIsOpen ? openTooltipPopup(e) : closeTooltipPopup(shutUp)
        }

        const openSettingsPopup = function () {
            document.getElementById('settingsGear').classList.add(['one-time-gear-roll'])
            document.getElementById('board').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('planchette').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('planchetteHelper').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('spiritMessageContainer').style.visibility = `hidden`
            document.getElementById('userMessageContainer').style.visibility = `hidden`
            document.getElementById('settingsPopup').style.opacity = '1'
            document.getElementById('settingsPopup').style.display = `block`
        }

        const closeSettingsPopup = function () {
            document.getElementById('settingsGear').classList.remove(['one-time-gear-roll'])
            document.getElementById('planchette').style.removeProperty('filter')
            document.getElementById('settingsPopup').style.display = 'none'
            document.getElementById('board').style.filter = `none`;
            document.getElementById('planchetteHelper').style.filter = `none`;
            document.getElementById('spiritMessageContainer').style.visibility = `visible`
            document.getElementById('userMessageContainer').style.visibility = `visible`;
        }

        const toggleSettingsPopup = function () {
            popupIsOpen = !popupIsOpen
            popupIsOpen ? openSettingsPopup() : closeSettingsPopup()
        }

        const toggleShowTips = function () {
            showTips = !showTips
            const slider = document.getElementById('showTipsSliderSlider')
            if (showTips) {
                slider.classList.add(['checked'])
                startSmokeAnimation()
            } else {
                slider.classList.remove(['checked'])
                stopSmokeAnimation()
            }
        }

        const toggleRevealMouse = function () {
            revealMouse = !revealMouse
            const slider = document.getElementById('revealMouseSliderSlider')
            if (!revealMouse) {
                slider.classList.remove(['checked'])
                document.getElementById('planchetteHelper').style.opacity = 0
                document.getElementById('bg').style.cursor = 'none'
                document.getElementById('hoverBoard').style.cursor = 'none'
                document.getElementById('planchette').style.cursor = 'none'
                document.getElementById('planchetteHelper').style.cursor = 'none'
            } else {
                slider.classList.add(['checked'])
                document.getElementById('planchetteHelper').style.opacity = 0.5
                document.getElementById('bg').style.cursor = 'auto'
                document.getElementById('hoverBoard').style.cursor = 'auto'
                document.getElementById('planchette').style.cursor = 'auto'
                document.getElementById('planchetteHelper').style.cursor = 'auto'
            }
        }

        const toggleSpeedMode = function () {
            speedMode = !speedMode
            const slider = document.getElementById('speedModeSliderSlider')
            if (speedMode) {
                slider.classList.add(['checked'])
            } else {
                slider.classList.remove(['checked'])
            }
            if (speedMode && remainingGoals.length > 0) {
                turn = TURN_USER
                const container = document.getElementById('spiritMessageContainer')
                container.innerText = revealedSpiritLetters + remainingGoals
                container.setAttribute('data-text', revealedSpiritLetters + remainingGoals)
                document.getElementById('userMessagePre').innerText = ''
                document.getElementById('userMessagePre').classList = ['unselectable blinking-caret']
                document.getElementById('planchette').classList = ['unselectable planchette-no-glow']
                remainingGoals = ''
                currentExchangeNumber++
            }
        }

        const toggleOpenAI = function () {
            using_GPT3 = !using_GPT3
            const slider = document.getElementById('openAISliderSlider')
            if (!using_GPT3) {
                slider.classList.remove(['checked'])
                document.getElementById('settingsPopupButtonsContainer').style.marginTop = '1.5vw'
                document.getElementById('textInputAPIKey').style.marginTop = '1.7vw'
            } else {
                slider.classList.add(['checked'])
                document.getElementById('settingsPopupButtonsContainer').style.marginTop = '4.1vw'
                document.getElementById('textInputAPIKey').value = window.localStorage.getItem('ouija-openai-api-key')
                document.getElementById('textInputAPIKey').style.marginTop = '1vw'
            }

        }

        const userPastedAPIKey = function () {
            window.localStorage.setItem('ouija-openai-api-key', document.getElementById('textInputAPIKey').value)
        }

        const mouseCheck = function () {
            if (userMoveCount < 20) {
                document.getElementById('mouseRequirement').style.color = 'red'
                return false
            }
            return true
        }

        const openConsentPopup = function () {
            popupIsOpen = true
            document.getElementById('board').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('planchette').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('planchetteHelper').style.filter = `blur(10px) brightness(0.6)`
            document.getElementById('userMessageContainer').style.visibility = `hidden`
            document.getElementById('consentPopup').style.display = `block`
            document.getElementById('settingsGear').style.opacity = `0`
            document.getElementById('settingsGear').style.transition = `opacity 3s`
        }

        const closeConsentPopup = function () {
            if (!mouseCheck()) return
            popupIsOpen = false
            window.localStorage.setItem(OUIJA_USER_ID, 'user' + Math.round(1000000000 * Math.random()))
            document.getElementById('consentPopup').style.opacity = '0'
            document.getElementById('settingsGear').style.opacity = `0.7`
            setTimeout(() => {
                document.getElementById('consentPopup').style.display = 'none'
                document.getElementById('settingsGear').style.removeProperty('opacity')
                document.getElementById('settingsGear').style.removeProperty('transition')
                createTooltip(0)
            }, 3000)
            document.getElementById('board').style.filter = `none`;
            document.getElementById('planchette').style.removeProperty('filter')
            document.getElementById('planchetteHelper').style.filter = `none`;
            document.getElementById('userMessageContainer').style.visibility = `visible`;
            document.getElementById('consentYes').classList.add(['one-time-bump'])
            const elementsToFadeOut = document.getElementsByClassName('consentText')
            for (let i = 0; i < elementsToFadeOut.length; i++) {
                elementsToFadeOut[i].style.opacity = '0.4';
            }
            document.getElementById('changingConsentText').innerText = 'Thank you for complying. We shall come for your soul after death.'
            document.getElementById('consentYes').style.pointerEvents = 'none'
            document.getElementById('consentNo').style.pointerEvents = 'none'
        }

        const consentYes = function () {
            logToSumoLogic('!CONSENT_YES')
            closeConsentPopup()
        }

        const consentNo = function () {
            if (!mouseCheck()) return
            logToSumoLogic('!CONSENT_NO')
            // Make it appear as if the user clicked 'yes', even though they actually clicked 'no'
            const shiftXbuttonWidth = document.getElementById('consentNo').getBoundingClientRect().width * 100.0 / planchetteWidth
            const shiftXmarginWidth = windowWidth * 1.5 / planchetteWidth
            const shiftX = shiftXbuttonWidth + shiftXmarginWidth
            offsetX -= shiftX // Shift mouse to consentYes button
            planchetteTransformX += shiftX // Negate any effect on planchette's position
            const cursor = document.getElementById("cursor")
            paintCursorWithOffset(cursor, prevX, prevY)
            closeConsentPopup()
        }

        let pauseSmokeAnimation = true
        let timerToPauseSmokeAnimation = null
        const startSmokeAnimation = function () {
            // This is complicated because we have a scale transition to start/stop smoke animation,
            // and after that transition is done we want to kill our animation tick for performance reasons.
            // The user might toggle on/off before the transition is completed.
            if (timerToPauseSmokeAnimation) {
                // This might happen if the user quickly toggles tips off and on.
                clearTimeout(timerToPauseSmokeAnimation)
                document.getElementById('animateRemoveFocus').beginElement()
            }
            document.getElementById('tooltipSymbol').style.transform = 'scale(1.0)'
            document.getElementById('tooltipSymbol').style.filter = 'blur(11px)'
            document.getElementById('tooltipSymbol').style.opacity = '1.0'
            if (!pauseSmokeAnimation) {
                return
            }
            pauseSmokeAnimation = false
            const filter = document.getElementById("smokeFilterTurbulence");
            let frames = 1;
            let rad = Math.PI / 180;
            let bfx, bfy;
            let prevTime = Date.now()
            const tickSmokeAnimation = function () {
                if (pauseSmokeAnimation) {
                    // This pause only exists for performance reasons, smoke would be hidden anyway.
                    return
                }
                // Use elapsedTime to stabilize animation speed regardless of device
                const currTime = Date.now()
                const timeElapsed = currTime - prevTime
                prevTime = currTime
                frames += .02 * timeElapsed

                bfx = 0.03;
                bfy = 0.03;

                bfx += 0.005 * Math.cos(frames * rad);
                bfy += 0.005 * Math.sin(frames * rad);

                bf = bfx.toString() + " " + bfy.toString();
                filter.setAttributeNS(null, "baseFrequency", bf);

                // Use requestIdleBallback instead of requestAnimationFrame, because 
                // we want our mouse move event listener callbacks to be prioritized
                // higher than this low-prio animation in the queue for event loop.
                window.requestIdleCallback(tickSmokeAnimation);
            }
            window.requestIdleCallback(tickSmokeAnimation);
        }

        const stopSmokeAnimation = function () {
            document.getElementById('tooltipSymbol').style.transform = 'scale(3.0)'
            document.getElementById('tooltipSymbol').style.filter = 'blur(13px)'
            document.getElementById('tooltipSymbol').style.opacity = '0.0'
            document.getElementById('animateDissipate').setAttributeNS(null, 'from', document.getElementById('smokeFilterMap').scale.animVal)
            document.getElementById('animateDissipate').beginElement()
            timerToPauseSmokeAnimation = setTimeout(() => {
                pauseSmokeAnimation = true
                document.getElementById('tooltipSymbol').classList.add('disable-transitions')
                document.getElementById('tooltipSymbol').style.transform = 'scale(0.0)'
                document.getElementById('tooltipSymbol').style.filter = 'blur(11px)'
                document.getElementById('tooltipSymbol').style.opacity = '1.0'
                document.getElementById('tooltipSymbol').offsetHeight // Trigger a reflow while transitions are disabled.
                document.getElementById('tooltipSymbol').classList.remove('disable-transitions')
                document.getElementById('animateRemoveFocus').beginElement()
            }, 2000)
        }

    </script>
</head>

<body>

    <!-- Background element for mousemove events -->
    <div id="bg" class="unselectable"></div>

    <!-- Warning: dont move elements outside boardContainer, otherwise browser resizing will cause inconsistencies in positioning! -->
    <div id="boardContainer" class="unselectable">

        <!-- Board visual -->
        <img id="board" class="unselectable" src="assets/ouija_bg.jpg"></img>

        <!-- Fix edge case where mousemove events aren't captured on board's rounded corners -->
        <div id="hoverBoard" class="unselectable"></div>

        <!-- Planchette is visible and moves according to fake cursor, planchetteHelper is invisible and moves according to real cursor -->
        <img id="planchette" class="unselectable planchette-no-glow" src="assets/planchette2.png"></img>
        <img id="planchetteHelper" class="unselectable" src="assets/planchette2.png"></img>

        <!-- Smokey tooltip -->
        <div id="tooltipContainer">
            <div id="tooltipSymbol">?</div>
            <svg width="0">
                <filter id="smokeFilter">
                    <feTurbulence id="smokeFilterTurbulence" type="fractalNoise" baseFrequency=".03" numOctaves="20" />
                    <feDisplacementMap id="smokeFilterMap" in="SourceGraphic" scale="50">
                        <animate id="animateToFocus" attributeName="scale" from="50" to="15" dur="2s" repeatCount="0"
                            restart="always" begin="indefinite" fill="freeze" />
                        <animate id="animateRemoveFocus" attributeName="scale" from="15" to="50" dur="2s"
                            repeatCount="0" restart="always" begin="indefinite" fill="freeze" />
                        <animate id="animateDissipate" attributeName="scale" from="15" to="200" dur="2s" repeatCount="0"
                            restart="always" begin="indefinite" fill="freeze" />
                    </feDisplacementMap>
                </filter>
            </svg>
        </div>

        <!-- Magnifying glass -->
        <div id="magnifying-glass" class="unselectable">
            <div id="magnifying-glass-surface"></div>
        </div>

        <!-- Revealed portion of spirit message -->
        <div id="spiritMessageContainer" class="unselectable" data-text=""></div>

        <!-- User message -->
        <div id="userMessageContainer" class="unselectable">
            <pre id="userMessagePre" class="unselectable blinking-caret"></pre>
        </div>

        <!-- Consent popup for first-time visitors -->
        <div id="consentPopup" class="unselectable popupContainer">
            <div class="unselectable popupHoverboard"></div>
            <h1 class="consentText">Welcome, friend</h1>
            <ul class="consentText">
                <li>This website provides a horror experience. It is akin to a magic show; no actual spirits are
                    involved.
                </li>
                <li>Your conversations with spirits are recorded for development purposes, so do not divulge any
                    sensitive
                    information.</li>
                <li id="mouseRequirement">This experience requires a mouse. Please use your mouse to proceed.</li>
            </ul>
            <p id="changingConsentText">Would you like to offer your soul to support this website?</p>
            <div class="popupButtonsContainer">
                <div id="consentYes" class="popupButton primaryButton">Consent to selling your soul</div>
                <div id="consentNo" class="popupButton">Enter without selling your soul</div>
            </div>
        </div>

        <!-- Tooltip popup -->
        <div id="tooltipPopup" class="unselectable popupContainer">
            <div class="unselectable popupHoverboard"></div>
            <div id="tooltipContent">
            </div>
            <div class="popupButtonsContainer">
                <div id="tooltipContinueButton" class="popupButton primaryButton">Continue</div>
                <div id="tooltipShutUpButton" class="popupButton">No more tips</div>
            </div>
        </div>

        <!-- Settings popup -->
        <div id="settingsPopup" class="unselectable popupContainer">
            <div class="unselectable popupHoverboard"></div>
            <div id="popupSettings">
                <h1>Switchboard</h1>
                <a href="https://www.youtube.com/watch?v=uTmBeR32GRA" target="_blank">
                    <div id="extRowMusic" class="externalLinkRow">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                            <path
                                d="M384 320c-17.67 0-32 14.33-32 32v96H64V160h96c17.67 0 32-14.32 32-32s-14.33-32-32-32L64 96c-35.35 0-64 28.65-64 64V448c0 35.34 28.65 64 64 64h288c35.35 0 64-28.66 64-64v-96C416 334.3 401.7 320 384 320zM488 0H352c-12.94 0-24.62 7.797-29.56 19.75c-4.969 11.97-2.219 25.72 6.938 34.88L370.8 96L169.4 297.4c-12.5 12.5-12.5 32.75 0 45.25C175.6 348.9 183.8 352 192 352s16.38-3.125 22.62-9.375L416 141.3l41.38 41.38c9.156 9.141 22.88 11.84 34.88 6.938C504.2 184.6 512 172.9 512 160V24C512 10.74 501.3 0 488 0z" />
                        </svg>
                        <span>Recommended background music</span>
                    </div>
                </a>
                <a href="https://github.com/baobabKoodaa/ouija" target="_blank">
                    <div id="extRowGithub" class="externalLinkRow">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                            <path
                                d="M384 320c-17.67 0-32 14.33-32 32v96H64V160h96c17.67 0 32-14.32 32-32s-14.33-32-32-32L64 96c-35.35 0-64 28.65-64 64V448c0 35.34 28.65 64 64 64h288c35.35 0 64-28.66 64-64v-96C416 334.3 401.7 320 384 320zM488 0H352c-12.94 0-24.62 7.797-29.56 19.75c-4.969 11.97-2.219 25.72 6.938 34.88L370.8 96L169.4 297.4c-12.5 12.5-12.5 32.75 0 45.25C175.6 348.9 183.8 352 192 352s16.38-3.125 22.62-9.375L416 141.3l41.38 41.38c9.156 9.141 22.88 11.84 34.88 6.938C504.2 184.6 512 172.9 512 160V24C512 10.74 501.3 0 488 0z" />
                        </svg>
                        <span>View source code</span>
                    </div>
                </a>
                <a href="https://attejuvonen.fi/contact" target="_blank">
                    <div id="extRowFeedback" class="externalLinkRow">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                            <path
                                d="M384 320c-17.67 0-32 14.33-32 32v96H64V160h96c17.67 0 32-14.32 32-32s-14.33-32-32-32L64 96c-35.35 0-64 28.65-64 64V448c0 35.34 28.65 64 64 64h288c35.35 0 64-28.66 64-64v-96C416 334.3 401.7 320 384 320zM488 0H352c-12.94 0-24.62 7.797-29.56 19.75c-4.969 11.97-2.219 25.72 6.938 34.88L370.8 96L169.4 297.4c-12.5 12.5-12.5 32.75 0 45.25C175.6 348.9 183.8 352 192 352s16.38-3.125 22.62-9.375L416 141.3l41.38 41.38c9.156 9.141 22.88 11.84 34.88 6.938C504.2 184.6 512 172.9 512 160V24C512 10.74 501.3 0 488 0z" />
                        </svg>
                        <span>Send feedback</span>
                    </div>
                </a>
                <label class="switch" id="showTipsSlider">
                    <span id="showTipsSliderSlider" class="slider checked"></span>
                    <p class="slider-text">Show tips</p>
                </label>
                <label class="switch" id="revealMouseSlider">
                    <span id="revealMouseSliderSlider" class="slider"></span>
                    <p class="slider-text">Reveal mouse magic</p>
                </label>
                <label class="switch" id="speedModeSlider">
                    <span id="speedModeSliderSlider" class="slider"></span>
                    <p class="slider-text">Speed mode</p>
                </label>
                <label class="switch" id="openAISlider">
                    <span id="openAISliderSlider" class="slider"></span>
                    <p class="slider-text">Use gpt3 (requires openai api key)</p>
                </label>
            </div>
            <input id="textInputAPIKey" type="password" placeholder="Paste your OpenAI API key here"
                onChange="userPastedAPIKey()"></input>
            <div id="settingsPopupButtonsContainer" class="popupButtonsContainer">
                <div id="saveSettings" class="popupButton primaryButton">Continue</div>
            </div>
        </div>

        <!-- Preload cursor icons like this -->
        <img src="assets/aero_arrow.cur" style="visibility: hidden; position: absolute; pointer-events: none;" />
        <img src="assets/aero_link.cur" style="visibility: hidden; position: absolute; pointer-events: none;" />
        <img src="assets/grab.cur" style="visibility: hidden; position: absolute; pointer-events: none;" />
        <img src="assets/grabbing.cur" style="visibility: hidden; position: absolute; pointer-events: none;" />
        <img src="assets/beam_i.cur" style="visibility: hidden; position: absolute; pointer-events: none;" />

        <!-- Displayed cursor whose src is altered as needed -->
        <img src="assets/aero_arrow.cur" id="cursor" />
    </div>

    <!-- Settings gear icon -->
    <div id="settingsGearHoverboard"></div>
    <div id="settingsGear">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path
                d="M495.9 166.6C499.2 175.2 496.4 184.9 489.6 191.2L446.3 230.6C447.4 238.9 448 247.4 448 256C448 264.6 447.4 273.1 446.3 281.4L489.6 320.8C496.4 327.1 499.2 336.8 495.9 345.4C491.5 357.3 486.2 368.8 480.2 379.7L475.5 387.8C468.9 398.8 461.5 409.2 453.4 419.1C447.4 426.2 437.7 428.7 428.9 425.9L373.2 408.1C359.8 418.4 344.1 427 329.2 433.6L316.7 490.7C314.7 499.7 307.7 506.1 298.5 508.5C284.7 510.8 270.5 512 255.1 512C241.5 512 227.3 510.8 213.5 508.5C204.3 506.1 197.3 499.7 195.3 490.7L182.8 433.6C167 427 152.2 418.4 138.8 408.1L83.14 425.9C74.3 428.7 64.55 426.2 58.63 419.1C50.52 409.2 43.12 398.8 36.52 387.8L31.84 379.7C25.77 368.8 20.49 357.3 16.06 345.4C12.82 336.8 15.55 327.1 22.41 320.8L65.67 281.4C64.57 273.1 64 264.6 64 256C64 247.4 64.57 238.9 65.67 230.6L22.41 191.2C15.55 184.9 12.82 175.3 16.06 166.6C20.49 154.7 25.78 143.2 31.84 132.3L36.51 124.2C43.12 113.2 50.52 102.8 58.63 92.95C64.55 85.8 74.3 83.32 83.14 86.14L138.8 103.9C152.2 93.56 167 84.96 182.8 78.43L195.3 21.33C197.3 12.25 204.3 5.04 213.5 3.51C227.3 1.201 241.5 0 256 0C270.5 0 284.7 1.201 298.5 3.51C307.7 5.04 314.7 12.25 316.7 21.33L329.2 78.43C344.1 84.96 359.8 93.56 373.2 103.9L428.9 86.14C437.7 83.32 447.4 85.8 453.4 92.95C461.5 102.8 468.9 113.2 475.5 124.2L480.2 132.3C486.2 143.2 491.5 154.7 495.9 166.6V166.6zM256 336C300.2 336 336 300.2 336 255.1C336 211.8 300.2 175.1 256 175.1C211.8 175.1 176 211.8 176 255.1C176 300.2 211.8 336 256 336z" />
        </svg>
    </div>

    <!-- Error message for users who have disabled JavaScript -->
    <noscript>
        <h1>This website requires JavaScript in order to do some tricks. Please enable JavaScript and refresh.</h1>
    </noscript>

    <!-- Error message for users who are on mobile devices -->
    <div id="mobileWarning">
        <h1>
            Your device is not supported, sorry. Can you come back on a desktop/laptop? You need a mouse and at least
            1200 pixels wide screen.
        </h1>
    </div>

    <script>

        const switchToNormalCursor = function (e) {
            stopDraggingPlanchette(e)
            document.getElementById("cursor").style.visibility = "hidden"
            clearOffsets()
            updatePlanchettePosition()
        }

        // Mouse move events
        document.getElementById('bg').addEventListener('mousemove', e => { mouseMoved(e) })
        document.getElementById('hoverBoard').addEventListener('mousemove', e => { mouseMoved(e) })
        document.getElementById('planchette').addEventListener('mousemove', e => { mouseMoved(e) })
        document.getElementById('planchetteHelper').addEventListener('mousemove', e => { mouseMoved(e, ON_PLANCHETTE) })
        document.querySelectorAll('.popupHoverboard').forEach((element) => element.addEventListener('mousemove', e => { mouseMoved(e) }))
        document.querySelectorAll('.popupButton').forEach((element) => element.addEventListener('mousemove', e => { mouseMoved(e, ON_BUTTON) }))
        document.querySelectorAll('.slider').forEach((element) => element.addEventListener('mousemove', e => { mouseMoved(e, ON_BUTTON) }))
        document.getElementById('extRowMusic').addEventListener('mousemove', e => { mouseMoved(e, ON_BUTTON) })
        document.getElementById('extRowGithub').addEventListener('mousemove', e => { mouseMoved(e, ON_BUTTON) })
        document.getElementById('extRowFeedback').addEventListener('mousemove', e => { mouseMoved(e, ON_BUTTON) })

        // Button click events
        document.getElementById('consentYes').addEventListener('click', e => { consentYes() })
        document.getElementById('consentNo').addEventListener('click', e => { consentNo() })
        document.getElementById('bg').addEventListener('click', e => { if (hoveringOverTooltip && showTips && !pauseSmokeAnimation) toggleTooltipPopup(e) })
        document.getElementById('hoverBoard').addEventListener('click', e => { if (hoveringOverTooltip && showTips && !pauseSmokeAnimation) toggleTooltipPopup(e) })
        document.getElementById('tooltipContinueButton').addEventListener('click', e => { toggleTooltipPopup(e) })
        document.getElementById('tooltipShutUpButton').addEventListener('click', e => { toggleTooltipPopup(e, SHUT_UP) })
        document.getElementById('saveSettings').addEventListener('click', e => { toggleSettingsPopup() })
        document.getElementById('showTipsSlider').addEventListener('click', e => { toggleShowTips() })
        document.getElementById('revealMouseSlider').addEventListener('click', e => { toggleRevealMouse() })
        document.getElementById('speedModeSlider').addEventListener('click', e => { toggleSpeedMode() })
        document.getElementById('openAISlider').addEventListener('click', e => { toggleOpenAI() })
        document.getElementById('settingsGear').addEventListener('click', e => { toggleSettingsPopup() })

        // Activating planchetteDragging
        document.getElementById('planchetteHelper').addEventListener('mousedown', e => { startDraggingPlanchette(e) })

        // Deactivating planchetteDragging
        document.getElementById('planchetteHelper').addEventListener('mouseup', e => { stopDraggingPlanchette(e, ON_PLANCHETTE) })
        document.body.addEventListener('mouseup', e => { stopDraggingPlanchette(e) })

        // Switches from fake cursor to normal cursor
        document.body.addEventListener('mouseleave', e => { switchToNormalCursor(e) })
        document.getElementById('settingsGearHoverboard').addEventListener('mousemove', e => { switchToNormalCursor(e) })
        document.getElementById('textInputAPIKey').addEventListener('mousemove', e => { switchToNormalCursor(e) })

        // Keydown events
        document.body.addEventListener('keydown', e => {
            const lowerCasedChar = e.key.toLocaleLowerCase()
            if (turn === TURN_USER && !popupIsOpen) {
                const m = document.getElementById('userMessagePre')
                if (ALLOWED_CHARS.includes(lowerCasedChar) || lowerCasedChar == ' ') {
                    if (m.innerText.length < USER_MESSAGE_MAX_LENGTH) {
                        m.innerText += lowerCasedChar.toUpperCase()
                    }
                } else if (e.key == 'Enter') {
                    if (m.innerText.length >= 2) {
                        const userQuestion = m.innerText
                        console.log('Player: ' + userQuestion)
                        switchTurnToSpirit()
                        dispatchToSpirit(userQuestion, spiritIsReadyToCommunicate)
                    }
                } else if (e.key == 'Backspace' && m.innerText.length > 0) {
                    m.innerText = m.innerText.substring(0, m.innerText.length - 1)
                }
            }

            // Helpers for debugging
            if (!window.location.href.endsWith("#debug")) {
                return
            }
            if (e.key == "=") {
                debug[RECORDING] = {}
                console.log('Recording')
            }
        })

        const cleanText = function (rawText) {
            const lowerCased = rawText.toLocaleLowerCase()
            let filtered = ''
            for (let i = 0; i < lowerCased.length; i++) {
                if (ALLOWED_CHARS.includes(lowerCased[i])) {
                    filtered += lowerCased[i]
                }
            }
            return filtered
        }

        if (!window.localStorage.getItem(OUIJA_USER_ID)) {
            openConsentPopup()
        } else {
            setTimeout(() => createTooltip(0), 1000)
        }

        if (window.innerWidth < 1200) {
            document.getElementById('mobileWarning').style.display = 'block';
        }

        // fetch('http://ip-api.com/json')
        //     .then(res => res.json())
        //     .then(response => {
        //         console.log("City: ", response.city);
        //     })
        //     .catch((data, status) => {
        //         console.log('Request failed');
        //     })

    </script>

    <script async src="chatbot.js"></script>

    <!--     <audio autoplay controls>
        <source src="assets/dk-atmosphere.mp3" type="audio/mpeg">
    </audio> -->

    <script defer data-domain="ouija.attejuvonen.fi" src="https://plausible.io/js/plausible.js"></script>

    <!-- <iframe width="361" height="25" src="https://www.youtube.com/embed/F0Jk80wDw2w" title="YouTube video player"
        frameborder="0" allowfullscreen="false"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe> -->

</body>

</html>